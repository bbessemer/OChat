(function(n){var m;m=function(){function a(){}a.authorized=!1;a.username="";a.token="";a.server="";a.board="";a.lastMessageId=0;a.messageLog=[];a.signingKey=null;a.privateKey=null;a.verificationKeys=[];a.messagesReceivedHandlers=[];a.addMessagesReceivedHandler=function(a){return this.messagesReceivedHandlers.push(a)-1};a.removeMessagesReceivedHandler=function(a){var b,e;if("number"===typeof a)return this.messagesReceivedHandlers.splice(a,1);b=0;for(e=[];-1!==b;)e.push(this.messagesReceivedHandlers.splice(b=
this.messagesReceivedHandlers.indexOf(a),1));return e};a.messagesReceived=function(a){var b,e,d,f;d=this.messagesReceivedHandlers;f=[];b=0;for(e=d.length;b<e;b++)a=d[b],"function"===typeof a?f.push(a(message)):f.push(void 0);return f};a.refreshToken=function(){var c;if(null!=this.privateKey&&null!=this.signingKey)return c=new XMLHttpRequest,c.open("GET","#{@server}#{@board}?get=token&token=#{@token}",!0),c.onreadystatechange=function(){if(null!=a.privateKey&&null!=a.signingKey&&4===this.readystate&&
200===this.status)return a.token=a.privateKey.decrypt(this.responseText)},c.send()};a.send=function(c){var b,e,d,f,g,h;f=new Date;b={};g=!1;navigator.geolocation?(g=!0,navigator.geolocation.getCurrentPosition(function(a){b.lat=a.coords.latitude;b.lng=a.coords.longitude;return g=!1},function(){return g=!1})):b=null;for(;g;);d={sentBy:this.username,timestamp:f.getTime(),timezone:-60*f.getTimezoneOffset(),sentFrom:b,text:c,sent:!1};c=new XMLHttpRequest;c.open("POST","#{@server}#{@board}?token=#{@token}",
!0);c.onreadystatechange=function(){if(4===this.readystate&&200===this.status)return d.sent=!0,a.token=a.privateKey.decrypt(this.responseText)};e=this.signingKey.sign(hexify(JSON.stringify(d)));c.send(JSON.stringify({u:this.username,c:function(){var a,b,c;if("string"===typeof e)return hex2b64(e);c=[];a=0;for(b=e.length;a<b;a++)h=e[a],c.push(hex2b64(h));return c}()}));this.messageLog.push(d)};a.check=function(){var c;a.checking=!0;c=new XMLHttpRequest;c.open("GET","#{@server}#{@board}?get=#{@lastMessageId}+new&token=#{@token}",
!0);c.onreadystatechange=function(){var b,c,d,f;4===this.readystate&&200===this.status&&(d=JSON.parse(this.responseText),a.token=d.token,null!=d.msgs&&(a.messageLog.concat(b=function(){var b,h,k,l;k=d.msgs;l=[];b=0;for(h=k.length;b<h;b++)c=k[b],l.push(JSON.parse(a.verificationKeys[c.u].decrypt(function(){var a,b,d,g;if("string"===typeof c.c)return b64tohex(c.c);d=c.c;g=[];a=0;for(b=d.length;a<b;a++)f=d[a],g.push(b64tohex(f));return g}())));return l}()),a.messagesReceived(b)));return a.checking=!1};
return c.send()};return a}();n.OChat=m})(this);